var SWFUpload_Discuz = SWFUpload;var HTML5Upload = function(settings){this.init_(settings);};if (window.XMLHttpRequest &&window.FormData &&window.ProgressEvent &&Object.defineProperty &&'multiple' in document.createElement('input')) {SWFUpload = HTML5Upload;if (!Array.prototype.find) {Object.defineProperty(Array.prototype, 'find', {value: function(predicate) {if (this == null) {throw new TypeError('"this" is null or not defined');}var o = Object(this);var len = o.length >>> 0;if (typeof predicate !== 'function') {throw new TypeError('predicate must be a function');}var thisArg = arguments[1];var k = 0;while (k < len) {var kValue = o[k];if (predicate.call(thisArg, kValue, k, o)) {return kValue;}k++;}return undefined;}});}}['QUEUE_ERROR', 'UPLOAD_ERROR', 'FILE_STATUS', 'UPLOAD_TYPE', 'BUTTON_ACTION', 'CURSOR'].forEach(function(k) {HTML5Upload[k] = SWFUpload_Discuz[k];});HTML5Upload.ERROR_CODE_MAP = {'default': {errorCode: SWFUpload.UPLOAD_ERROR.HTTP_ERROR,message: '上传失败',},'-1': {errorCode: SWFUpload.UPLOAD_ERROR.HTTP_ERROR,message: '不支持此类扩展名',},'-2': {errorCode: SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED,message: '服务器限制无法上传那么大的附件',},'-3': {errorCode: SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED,message: '用户组限制无法上传那么大的附件',},'-4': {errorCode: SWFUpload.UPLOAD_ERROR.HTTP_ERROR,message: '不支持此类扩展名',},'-5': {errorCode: SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED,message: '文件类型限制无法上传那么大的附件',},'-6': {errorCode: SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED,message: '今日您已无法上传更多的附件',},'-7': {errorCode: SWFUpload.UPLOAD_ERROR.HTTP_ERROR,message: '请选择图片文件(jpg, jpeg, gif, png)',},'-8': {errorCode: SWFUpload.UPLOAD_ERROR.IO_ERROR,message: '附件文件无法保存',},'-9': {errorCode: SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED,message: '没有合法的文件被上传',},'-10': {errorCode: SWFUpload.UPLOAD_ERROR.SECURITY_ERROR,message: '非法操作',},'-11': {errorCode: SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED,message: '今日您已无法上传那么大的附件',},};HTML5Upload.registeredUploadTypes_ = {};HTML5Upload.currentInstanceId_ = 1;HTML5Upload.prototype.init_ = function(settings) {this.settings = settings;this.instanceId = HTML5Upload.currentInstanceId_++;if (settings.custom_settings) {this.customSettings = settings.custom_settings;} else {this.customSettings = {};}if (settings.extended_settings) {this.extendedSettings = settings.extended_settings;} else {this.extendedSettings = {};}if (this.customSettings.uploadType) {HTML5Upload.registeredUploadTypes_[this.customSettings.uploadType] = true;}this.container = document.getElementById(settings.button_placeholder_id) || settings.button_placeholder;this.currentFileId = 1;this.queue = [];this.initUI_();if (this.extendedSettings.editorId) {this.initEditor_(this.extendedSettings.editorId);}this.callHandler_('file_dialog_start');};HTML5Upload.prototype.initUI_ = function() {var spriteImg = new Image();spriteImg.onload = function() {this.buttonHeight_ = (spriteImg.height / 4) || this.settings.button_height;}.bind(this);spriteImg.src = this.settings.button_image_url;var input = document.createElement('input');input.type = 'file';if (this.settings.file_types) {input.accept = this.settings.file_types;}input.multiple = true;if (this.settings.button_image_url && this.settings.button_width && this.settings.button_height) {var label = document.createElement('label');var img = document.createElement('span');img.style = '-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;moz-user-select:none;-ms-user-select:none;user-select:none;';img.style.width = this.settings.button_width + 'px';img.style.height = this.settings.button_height + 'px';img.style.display = 'inline-block';img.style.background = 'url("' + this.settings.button_image_url + '") center top no-repeat';img.addEventListener('mouseover', function() {img.style.backgroundPosition = 'center top ' + -this.buttonHeight_ * 1 + 'px';}.bind(this));img.addEventListener('mouseout', function() {img.style.backgroundPosition = 'center top ' + -this.buttonHeight_ * 0 + 'px';}.bind(this));img.addEventListener('mousedown', function() {img.style.backgroundPosition = 'center top ' + -this.buttonHeight_ * 2 + 'px';}.bind(this));img.addEventListener('mouseup', function() {img.style.backgroundPosition = 'center top ' + -this.buttonHeight_ * 1 + 'px';}.bind(this));input.style.display = 'none';img.appendChild(document.createTextNode('\u00a0'));label.appendChild(input);label.appendChild(img);this.container.appendChild(label);} else {this.container.appendChild(input);}input.addEventListener('change', this.onFileSelected_.bind(this, input));};HTML5Upload.prototype.onFileSelected_ = function(input) {if (input.files.length == 0) {return;}this.queueFiles_(input.files);input.value = '';if (input.value) {input.type = '';input.type = 'file';}};HTML5Upload.prototype.queueFiles_ = function(files, source) {[].forEach.call(files, function(file) {file = {id: this.currentFileId++,name: file.name || this.generateFileName_(file),size: file.size,type: '',post: {},dom: file,source: source,};if (file.name.lastIndexOf('.') != -1) {file.type = file.name.substr(file.name.lastIndexOf('.')).toLowerCase();}if (source == 'dragdrop' || source == 'clipboard') {file.insert = true;}if (this.settings.file_size_limit && file.size > parseInt(this.settings.file_size_limit) * 1024) {this.callHandler_('file_queue_error', file, SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT, '');} else if (file.size == 0) {this.callHandler_('file_queue_error', file, SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE, '');} else if (this.settings.file_types && this.settings.file_types.toLowerCase().split(';').every(function(type) {return type.substr(0, 2) != '*.' || file.name.substr(-(type.length - 1)).toLowerCase() != type.substr(1);})) {this.callHandler_('file_queue_error', file, SWFUpload.QUEUE_ERROR.INVALID_FILETYPE, '');} else {if (this.customSettings.filterType) {for (var type in this.customSettings.filterType)if ('.' + type == file.name.substr(-(type.length + 1)).toLowerCase() && file.size > this.customSettings.filterType[type]) {this.callHandler_('file_queue_error', file, SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT, '');return;}}this.queue.push(file);this.callHandler_('file_queued', file);if (window.UPLOADSTATUS != undefined && window.UPLOADSTATUS != 1) {window.UPLOADSTATUS = 0;}}}.bind(this));this.callHandler_('file_dialog_complete', files.length, this.queue.length);};HTML5Upload.prototype.initEditor_ = function(editorId) {if (window.setEditorEvents && window.editdoc) {var old_setEditorEvents = window.setEditorEvents;window.setEditorEvents = function() {old_setEditorEvents();this.setExtraEditorEvents_();}.bind(this);this.setExtraEditorEvents_();var editorContainer = document.getElementById(editorId + '_body');editorContainer.addEventListener('drop', this.onDrop_.bind(this), true);editorContainer.addEventListener('dragenter', this.onDrag_.bind(this), true);editorContainer.addEventListener('dragover', this.onDrag_.bind(this), true);} else {console.error('TODO: Not sure what to do if editor.js is loaded after upload.js.')}};HTML5Upload.prototype.setExtraEditorEvents_ = function(editorId) {if (!editdoc.____HTML5UploadHasExtraEventListener____) {editdoc.____HTML5UploadHasExtraEventListener____ = {};}if (!editdoc.____HTML5UploadHasExtraEventListener____[this.instanceId]) {editdoc.____HTML5UploadHasExtraEventListener____ = true;editdoc.addEventListener('drop', this.onDrop_.bind(this), true);editdoc.addEventListener('dragenter', this.onDrag_.bind(this), true);editdoc.addEventListener('dragover', this.onDrag_.bind(this), true);editdoc.addEventListener('paste', this.onPaste_.bind(this), true);}};HTML5Upload.prototype.onDrag_ = function(e) {if ([].indexOf.call(e.dataTransfer.types, 'Files') != -1) {e.preventDefault();e.stopPropagation();e.dataTransfer.dropEffect = 'copy';} else {e.dataTransfer.dropEffect = 'none';}};HTML5Upload.prototype.onDrop_ = function(e) {var files = e.dataTransfer.files;if (files.length > 0) {e.preventDefault();e.stopPropagation();}files = [].filter.call(files, function(file) {var isImage = ['.jpg', '.jpeg', '.jpe', '.png', '.gif'].indexOf(file.name.substr(file.name.lastIndexOf('.')).toLowerCase()) != -1;if (this.customSettings.uploadType == 'image') {return isImage;} else if (this.customSettings.uploadType == 'attach') {return HTML5Upload.registeredUploadTypes_['image'] ? !isImage : true;} else {return false;}}.bind(this));if (files.length > 0) {this.queueFiles_(files, 'dragdrop');}};HTML5Upload.prototype.onPaste_ = function(e) {if (e.clipboardData && e.clipboardData.items && e.clipboardData.items.length) {var acceptedItems = [].filter.call(e.clipboardData.items, function(item) {var isImage = ['image/jpeg', 'image/png', 'image/gif'].indexOf(item.type) != -1;if (this.customSettings.uploadType == 'image') {return isImage;} else if (this.customSettings.uploadType == 'attach') {return HTML5Upload.registeredUploadTypes_['image'] ? !isImage : true;} else {return false;}}.bind(this));if (acceptedItems.length > 0) {this.queueFiles_(acceptedItems.map(function(item) {return item.getAsFile();}), 'clipboard');e.preventDefault();e.stopPropagation();}}};HTML5Upload.prototype.callHandler_ = function(name) {handler = this.settings[name + '_handler'];if (handler) {[].shift.apply(arguments);handler.apply(this, arguments);}};HTML5Upload.prototype.startUpload = function() {var file = this.queue.find(function(f) {return !f.xhr;});if (!file) {return;}this.callHandler_('upload_start', file);if (window.UPLOADSTATUS != undefined) {window.UPLOADSTATUS = 1;}var xhr = new XMLHttpRequest();file.xhr = xhr;xhr.open('POST', (this.settings.upload_url.indexOf('?') != -1 ? this.settings.upload_url + '&html5=' : this.settings.upload_url + '?html5=') + (file.source || this.customSettings.uploadType || '1'), true);var data = new FormData();if (this.settings.post_params) {for (var k in this.settings.post_params)data.append(k, this.settings.post_params[k]);}data.append('Filename', file.name);if ('name' in file.dom) {data.append('Filedata', file.dom);} else {data.append('Filedata', file.dom, this.generateFileName_(file.dom));}xhr.onload = function() {if (parseInt(xhr.responseText) < 0) {error = HTML5Upload.ERROR_CODE_MAP[xhr.responseText] || HTML5Upload.ERROR_CODE_MAP['default'];this.callHandler_('upload_error', file, error.errorCode, error.message);} else {this.callHandler_('upload_success', file, xhr.responseText);if (file.insert) {if (this.customSettings.uploadType == 'image') {var id = window.setInterval(function(aid) {if (document.getElementById('image_' + aid)) {insertAttachimgTag(aid);window.clearInterval(id);}}.bind(this, xhr.responseText), 250);} else if (this.customSettings.uploadType == 'attach') {insertAttachTag(xhr.responseText);} else {console.error('TODO: Possibly other uploadTypes exist?');}}}this.queueOut_(file);}.bind(this);xhr.onerror = function() {this.callHandler_('upload_error', file, SWFUpload.UPLOAD_ERROR.IO_ERROR, '内部服务器错误');this.queueOut_(file);}.bind(this);xhr.upload.onprogress = function(e) {if (e.lengthComputable) {this.callHandler_('upload_progress', file, e.loaded, e.total);}}.bind(this);xhr.send(data);};HTML5Upload.prototype.cancelUpload = function(fileID) {var file = this.queue.find(function(file) {return file.id == fileID;});if (file && file.xhr) {file.xhr.abort();this.callHandler_('upload_error', file, SWFUpload.UPLOAD_ERROR.FILE_CANCELLED, '');this.queueOut_(file);}};HTML5Upload.prototype.queueOut_ = function(file) {this.queue.splice(this.queue.indexOf(file), 1);this.callHandler_('upload_complete', file);if (this.queue.length == 0) {if (window.UPLOADSTATUS != undefined) {window.UPLOADSTATUS = 2;}if (window.AUTOPOST) {hideMenu();validate($('postform'));}}};HTML5Upload.prototype.getStats = function() {return this.stats ? {files_queued: this.queue.length,successful_uploads: this.stats.successful_uploads,upload_cancelled: this.stats.upload_cancelled,} : {files_queued: this.queue.length,successful_uploads: 0,upload_cancelled: 0,};};HTML5Upload.prototype.setStats = function(stats) {if (!this.stats) {this.stats = this.getStats();}['successful_uploads', 'upload_cancelled'].forEach(function(key) {if (stats[key] != undefined) {this.stats[key] = stats[key];}}.bind(this));};HTML5Upload.prototype.setPostParam = function(params) {this.settings.post_params = params;};HTML5Upload.prototype.addPostParam = function(name, value) {this.settings.post_params[name] = value;};HTML5Upload.prototype.debug = function(message) {console.debug(message);};HTML5Upload.prototype.generateFileName_ = function(file) {return 'Untitled' + ({'image/jpeg': '.jpg','image/gif': '.gif','image/png': '.png',}[file.type] || '');};