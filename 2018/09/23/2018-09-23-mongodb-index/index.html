<!DOCTYPE html>







<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



















  
  
  
  

  

  

  

  

  

  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="基本术语MongoDB 术语表 index/key/data pageMongoDB 索引由 key 和 data page 两部分组成：  key 是文档的 字段集合； data page 是存储在 disk 上的 document 的入口，有时也叫 pointer；  数据库中的索引（index）非常像书本的“索引”，作用是加速读操作，key 类似书本索引的关键字，而 data page 类似">
<meta name="keywords" content="MongoDB,索引">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB | 索引">
<meta property="og:url" content="http://songkun.me/2018/09/23/2018-09-23-mongodb-index/index.html">
<meta property="og:site_name" content="随便写写">
<meta property="og:description" content="基本术语MongoDB 术语表 index/key/data pageMongoDB 索引由 key 和 data page 两部分组成：  key 是文档的 字段集合； data page 是存储在 disk 上的 document 的入口，有时也叫 pointer；  数据库中的索引（index）非常像书本的“索引”，作用是加速读操作，key 类似书本索引的关键字，而 data page 类似">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://songkun.me/images/mongodb/ixscan-collscan.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-filter-1.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-filter-2.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-filter-3.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-filter-4.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-sort-1.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-order-filter-1.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-order-filter-2.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-order-sort-1.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/index-order-sort-2.png">
<meta property="og:image" content="http://songkun.me/images/mongodb/mongodb-memory-model.png">
<meta property="og:updated_time" content="2019-08-10T07:20:43.163Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MongoDB | 索引">
<meta name="twitter:description" content="基本术语MongoDB 术语表 index/key/data pageMongoDB 索引由 key 和 data page 两部分组成：  key 是文档的 字段集合； data page 是存储在 disk 上的 document 的入口，有时也叫 pointer；  数据库中的索引（index）非常像书本的“索引”，作用是加速读操作，key 类似书本索引的关键字，而 data page 类似">
<meta name="twitter:image" content="http://songkun.me/images/mongodb/ixscan-collscan.png">






  <link rel="canonical" href="http://songkun.me/2018/09/23/2018-09-23-mongodb-index/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MongoDB | 索引 | 随便写写</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?846ea2c0fbfe48d1fc36a417a790a68c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/satansk"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Follow me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">随便写写</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-books">
    <a href="/books" rel="section">
      <i class="menu-item-icon fa fa-fw fa-book"></i> <br>书单</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://songkun.me/2018/09/23/2018-09-23-mongodb-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Song Kun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随便写写">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MongoDB | 索引
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-23 23:17:10" itemprop="dateCreated datePublished" datetime="2018-09-23T23:17:10+08:00">2018-09-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-10 15:20:43" itemprop="dateModified" datetime="2019-08-10T15:20:43+08:00">2019-08-10</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="基本术语"><a href="#基本术语" class="headerlink" title="基本术语"></a>基本术语</h2><p><a href="https://docs.mongodb.com/manual/reference/glossary/" target="_blank" rel="noopener">MongoDB 术语表</a></p>
<h3 id="index-key-data-page"><a href="#index-key-data-page" class="headerlink" title="index/key/data page"></a>index/key/data page</h3><p>MongoDB 索引由 key 和 data page 两部分组成：</p>
<ul>
<li>key 是文档的 <strong>字段集合</strong>；</li>
<li>data page 是存储在 disk 上的 document 的入口，有时也叫 pointer；</li>
</ul>
<p>数据库中的索引（index）非常像书本的“索引”，作用是加速读操作，key 类似书本索引的关键字，而 data page 类似页码。</p>
<a id="more"></a>
<h3 id="covered-query-fetch"><a href="#covered-query-fetch" class="headerlink" title="covered query/fetch"></a>covered query/fetch</h3><p>一般而言，读操作分为两步：</p>
<ol>
<li>由索引的 key 找到目标文档的 data page；</li>
<li>根据 data page 将文档从磁盘 fetch 出来；</li>
</ol>
<p>若 <strong>所需字段</strong> 都在索引中，则不需要磁盘 fetch 就能获取所需数据，这就是 covered query。</p>
<p>查询覆盖（covered query）一般用于高并发、性能要求高的场景，可进一步加速读操作，但随之而来的是索引变大，需要更大的内存支撑。</p>
<h3 id="ixscan-collscan"><a href="#ixscan-collscan" class="headerlink" title="ixscan/collscan"></a>ixscan/collscan</h3><p>ixscan（索引扫描）和 collscan（集合扫描）效率差别很大：</p>
<ul>
<li>未命中索引时为 collscan，此时需要 fetch 磁盘上的所有文档才能完成查询，时间复杂度为 O(n)，查询效率随文档数量增加而急剧下降；</li>
<li>命中索引时为 ixscan，由于索引的底层数据结构（B 树）具备 O(logn) 的查询效率，因此即使文档数量急剧增加，查询效率下降不明显；</li>
</ul>
<p><img src="/images/mongodb/ixscan-collscan.png" alt="ixscan vs collscan" style="width: 400px;"></p>
<h3 id="query-shape"><a href="#query-shape" class="headerlink" title="query shape"></a>query shape</h3><p><a href="https://docs.mongodb.com/manual/reference/glossary/#term-query-shape" target="_blank" rel="noopener">query shape</a> 决定 <a href="https://docs.mongodb.com/manual/core/query-plans/" target="_blank" rel="noopener">query plan</a>。</p>
<p>例如 <code>db.test.find({name: &quot;Mike&quot;, age: 10})</code> 和 <code>db.test.find({name: &quot;Bob&quot;, age: 20})</code> 的 query shape 相同，都是 <code>{name: 1, age: 1}</code>，因此这两个查询的 query plan 也相同，将使用相同的 index 加速查询。</p>
<h3 id="index-prefix"><a href="#index-prefix" class="headerlink" title="index prefix"></a>index prefix</h3><p>复合索引有索引前缀的概念，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test.createIndex(&#123;firstName: 1, lastName: 1, gender: 1, age: 1&#125;)</span><br></pre></td></tr></table></figure>
<p>以上索引有 3 个前缀：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;firstName: 1&#125;</span><br><span class="line">&#123;firstName: 1, lastName: 1&#125;</span><br><span class="line">&#123;firstName: 1, lastName: 1, age: 1&#125;</span><br></pre></td></tr></table></figure>
<p>以上 3 个索引都是 <code>{firstName: 1, lastName: 1, gender: 1, age: 1}</code> 的前缀，将被其覆盖，没有必要单独创建，以避免浪费内存、磁盘空间。</p>
<h3 id="selectivity"><a href="#selectivity" class="headerlink" title="selectivity"></a>selectivity</h3><p>过滤性是指 index 过滤数据的能力，创建索引时，过滤性是重要的参考依据。</p>
<p>假设集合中有 10000 条文档，且：</p>
<ul>
<li>满足 <code>a = 100</code> 的文档有 1000 条</li>
<li>满足 <code>b = 10</code> 的文档有 100 条</li>
<li>满足 <code>c = 1</code> 的文档有 10 条</li>
</ul>
<p>则就过滤性而言，c &gt; b &gt; a，按照 c 过滤后的结果集最小。</p>
<p>若查询条件为 <code>a == 100 &amp;&amp; b == 10 &amp;&amp; c == 1</code>，且只能创建一个索引，则选择 c。</p>
<h3 id="复合索引-vs-多个单独索引"><a href="#复合索引-vs-多个单独索引" class="headerlink" title="复合索引 vs 多个单独索引"></a>复合索引 vs 多个单独索引</h3><p>接着前面的例子，对于 <code>a == 100 &amp;&amp; b == 10 &amp;&amp; c == 1</code>，考虑两种索引方式：</p>
<ul>
<li>复合索引 <code>{a: 1, b: 1, c: 1}</code></li>
<li>3 个单独索引：<ul>
<li><code>{a: 1}</code></li>
<li><code>{b: 1}</code></li>
<li><code>{c: 1}</code></li>
</ul>
</li>
</ul>
<p>如果使用 3 个单独索引，MongoDB 需要先分别为每个索引查询，得到 3 个结果集，然后在内存中取 3 个结果集的交集，非常耗时；如果是复合索引，则只会得到 1 个结果集，没有取交集的动作。</p>
<p>3 个单独索引还不如仅创建 <code>{c: 1}</code> 一个索引，如果你发现自己正在使用多个单独索引，那就要仔细考虑下了，一般会有更好的索引方式。</p>
<p>在传统的关系型数据库中，多个单独索引比在 MongoDB 中常见一些，原因是 MongoDB 是分布式数据库，为每个索引单独查询，然后取交集的代价非常大，因此 MongoDB 很不推荐这种做法。</p>
<h2 id="索引原理"><a href="#索引原理" class="headerlink" title="索引原理"></a>索引原理</h2><p>MongoDB 有以下索引类型：</p>
<ul>
<li>单字段索引（single-field index）</li>
<li>复合索引（compound index）</li>
<li>多键索引（multikey index）</li>
<li>地理位置索引（geospatial index）</li>
<li>全文索引（text index）</li>
</ul>
<p>其中单字段索引可以认为是只有一个字段的复合索引，而多键索引是建立在数组上的索引。</p>
<h3 id="索引的数据结构"><a href="#索引的数据结构" class="headerlink" title="索引的数据结构"></a>索引的数据结构</h3><p>不管是 NoSQL 还是关系型数据库，索引的原理基本都是相同的，其数据结构为 B/B+ 树，注意 B 树并不是 binary tree，而是 self-balancing tree。</p>
<p>索引可以用数组实现，也可以用 B 树实现，两者都可以实现高效查找：</p>
<ul>
<li>O(logn) 查找时间复杂度</li>
</ul>
<p>区别是插入时，维护数组的有序性代价非常高，而 B 树代价相对较低，因此数据库一般用 B 树实现数组。</p>
<p>虽然实际是用 B 树实现的，但可以用数组来讲解。</p>
<h4 id="单字段索引"><a href="#单字段索引" class="headerlink" title="单字段索引"></a>单字段索引</h4><p>索引 <code>{a: 1}</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.test.insert(&#123;a: 1&#125;)    [1]</span><br><span class="line">db.test.insert(&#123;a: 10&#125;)   [1, 10]</span><br><span class="line">db.test.insert(&#123;a: 5&#125;)    [1, 5, 10]</span><br><span class="line">db.test.insert(&#123;a: 7&#125;)    [1, 5, 7, 10]</span><br><span class="line">db.test.insert(&#123;a: 3&#125;)    [1, 3, 5, 7, 10]</span><br></pre></td></tr></table></figure>
<p>当插入、删除元素时，索引总是 <strong>保持有序</strong>，因为在有序 B 树/数组上，可以采用注入二分查找等算法，可以达到 O(logn) 的时间复杂度。</p>
<h4 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h4><p>索引 <code>{a: 1, b: 1}</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.test.insert(&#123;a: 1, b: 1&#125;)    [&#123;a: 1, b: &#123;1&#125;&#125;]</span><br><span class="line">db.test.insert(&#123;a: 1, b: 10&#125;)   [&#123;a: 1, b: &#123;1, 10&#125;&#125;]</span><br><span class="line">db.test.insert(&#123;a: 5, b: 10&#125;)   [&#123;a: 1, b: &#123;1, 10&#125;&#125;, &#123;a: 5, b: &#123;10&#125;&#125;]</span><br><span class="line">db.test.insert(&#123;a: 5, b: 7&#125;)    [&#123;a: 1, b: &#123;1, 10&#125;&#125;, &#123;a: 5, b: &#123;7, 10&#125;&#125;]</span><br></pre></td></tr></table></figure>
<p>对于 <code>db.test.find({a: 5, b: 7})</code>，首先在 <code>[1, 5]</code> 上搜索 <code>a == 5</code>，然后在 <code>[7, 10]</code> 数组上搜索 <code>b == 7</code>，因为是有序数组，可以用二分查找，时间复杂度为 O(logn)。</p>
<h3 id="索引作用：过滤"><a href="#索引作用：过滤" class="headerlink" title="索引作用：过滤"></a>索引作用：过滤</h3><p>索引最初的目的：加速查询。</p>
<p>假设索引为 <code>{a: 1, b: 1, c: 1}</code>，且索引内容为：</p>
<p><img src="/images/mongodb/index-filter-1.png" style="width: 400px;"></p>
<p>精确查询 <code>find({a: 2, b: 2, c: 3})</code> 过程如下：</p>
<p><img src="/images/mongodb/index-filter-2.png" style="width: 400px;"></p>
<p>范围查询 <code>find({a: 2, b: {$gte: 2, $lte: 3}, c: 1})</code> 过程如下：</p>
<p><img src="/images/mongodb/index-filter-3.png" style="width: 400px;"></p>
<p>范围查询 <code>find({a: 2, b: 3, c: {$gte: 2, $lte: 4}})</code> 过程如下：</p>
<p><img src="/images/mongodb/index-filter-4.png" style="width: 400px;"></p>
<p>无论是精确查询，还是范围查询，利用索引都能达到很好的查询效率。</p>
<h3 id="索引作用：排序"><a href="#索引作用：排序" class="headerlink" title="索引作用：排序"></a>索引作用：排序</h3><p>索引是有序的，如果按照索引顺序进行 <strong>遍历</strong>，则遍历结果也是有序的，可省去对结果集进行 <strong>内存排序</strong>，因此索引有助于排序。</p>
<blockquote>
<p>注意：</p>
<ul>
<li>并非是先查找到一个结果集，然后用索引对该结果集进行排序；</li>
<li>索引只有助于部分排序，内存排序有时无法避免；</li>
</ul>
</blockquote>
<p>假设有索引 <code>{a: 1, b: 1, c: 1}</code>，对于 <code>find({a: 2}).sort({b: -1, c: 1})</code>，借助索引，可以避免内存排序：</p>
<p><img src="/images/mongodb/index-sort-1.png" style="width: 400px;"></p>
<h3 id="索引顺序"><a href="#索引顺序" class="headerlink" title="索引顺序"></a>索引顺序</h3><p>索引顺序可能影响查询和排序。</p>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>查询：<code>find({a: 2, b: {$gte: 2, $lte: 3}, c: 1})</code>。</p>
<p>若索引为 <code>{a: 1, b: 1, c: 1}</code>，则查询过程如下：</p>
<p><img src="/images/mongodb/index-order-filter-1.png" style="width: 400px;"></p>
<ul>
<li>需要 4 次二分查找；</li>
</ul>
<p>若索引为 <code>{a: 1, c: 1, b: 1}</code>，则查询过程如下：</p>
<p><img src="/images/mongodb/index-order-filter-2.png" style="width: 400px;"></p>
<ul>
<li>需要 3 次二分查找；</li>
</ul>
<p>范围查找的键最好在索引的最后，以避免过早分叉，一分叉，后面的所有查询操作数量要翻倍。</p>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>索引顺序将影响索引是否能帮助排序。</p>
<p>假设查询为：<code>find({a: 2, b: {$gte: 2, $lte: 3}}).sort({c: 1})</code>。</p>
<p>若索引顺序为 <code>{a: 1, b: 1, c: 1}</code>，则执行过程如下：</p>
<p><img src="/images/mongodb/index-order-sort-1.png" style="width: 400px;"></p>
<p>该索引无法帮助排序，因为按 b 过滤之后出现分叉，每个 c 分支内是有序的，但无法保证两个 c 分支之间的顺序，因此必须 <strong>内存排序</strong>。</p>
<p>若索引顺序为 <code>{a: 1, c: 1, b: 1}</code>，则执行过程如下：</p>
<p><img src="/images/mongodb/index-order-sort-2.png" style="width: 400px;"></p>
<p>此时在第二层可以按 c 的索引顺序进行遍历，对于每个 c 元素，再继续进行范围查找，最后的结果是 c 升序的，因此无需内存排序。</p>
<h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><p>创建索引是一项非常耗时的操作，因为需要读取磁盘上的所有文档。</p>
<p>MongoDB 提供两种创建方式，通过 <code>background</code> 字段进行控制：</p>
<ul>
<li>前台创建</li>
<li>后台创建</li>
</ul>
<p>其中前台方式会锁住集合，造成暂时的服务不可用，因此几乎不推荐使用；后台方式不锁集合，但创建时间要长一些。</p>
<p>考虑索引顺序可能影响过滤、排序，推荐按如下方式创建索引：</p>
<ol>
<li>精确匹配字段：最前面</li>
<li>排序字段：中间<ol>
<li>最大化利用索引排序，避免内存排序</li>
</ol>
</li>
<li>范围匹配字段：最后面<ol>
<li>减少过滤时的比较次数，提升过滤效率</li>
</ol>
</li>
</ol>
<p>按照该原则创建出的索引一般是最优的。</p>
<h2 id="使用原则"><a href="#使用原则" class="headerlink" title="使用原则"></a>使用原则</h2><p><strong>1. 保证内存足以容纳索引（最基本）</strong></p>
<blockquote>
<p>使用 <code>db.stats().indexSize</code> 查看索引大小，单位为字节。</p>
</blockquote>
<p>CPU 缓存、内存、硬盘之间速度差别：</p>
<ul>
<li>缓存：馒头已经在嘴边，只需要咬一口；</li>
<li>内存：满足在盘子里，需要拿起来再咬一口；</li>
<li>机械硬盘：需要播种小麦、收割、磨面、做馒头，最后才能吃；</li>
<li>SSD：先去超时买面粉，然后做馒头，最后吃；</li>
</ul>
<p>若内存太小无法容纳索引，MongoDB 将使用 LRU 算法将索引在内存和硬盘之间进行交换。</p>
<p>因此若某查询所需索引不在内存，MongoDB 需要先将硬盘上的索引加载到内存中，然后再借助索引进行查找，最后的性能非常差，通常是无法接受的：</p>
<p><img src="/images/mongodb/mongodb-memory-model.png" style="width: 400px;"></p>
<p><strong>2. 一个查询至少要命中一个索引</strong></p>
<p>MongoDB 认为耗时超过 100ms 的查询为慢查询，并将其记录在日志中。</p>
<p><strong>3. 一个索引至少要被一个查询命中</strong></p>
<p>否则可以直接删除，因此索引是有代价的：</p>
<ul>
<li>影响写入操作</li>
<li>占用内存空间</li>
</ul>
<p>使用 <code>db.test.aggregrate([{$indexStats: {}}])</code> 可查看上次 MongoDB 重启后的索引命中情况。</p>
<p><strong>4. 在保证查询效率的前提下，索引应尽量少</strong></p>
<h2 id="特殊索引"><a href="#特殊索引" class="headerlink" title="特殊索引"></a>特殊索引</h2><h3 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h3><p>索引通过比较索引键进行工作，索引键越长，则比较操作消耗的 CPU 资源越多，而且当键大于 1024 字节时，MongoDB 禁止文档插入。</p>
<p>但如果需要索引的键就是非常长（文件路径、URL 路径等）怎么办呢？</p>
<p>此时用哈希索引，可以显著减少键的长度。</p>
<h3 id="部分索引"><a href="#部分索引" class="headerlink" title="部分索引"></a>部分索引</h3><p>有时仅需对部分文档创建索引，此时可以用部分索引，可减少索引大小，节省内存使用。</p>
<p>典型应用场景为：</p>
<ul>
<li>状态机</li>
<li>消息队列</li>
</ul>
<p>例如，若仅对 <code>init</code> 和 <code>error</code> 两个状态的文档创建索引，则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.test.createIndex(&#123;</span><br><span class="line">  stat: 1</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  partialFilterExpression: &#123;</span><br><span class="line">    stat: &#123;</span><br><span class="line">      $in: [&apos;init&apos;, &apos;error&apos;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="TTL-索引"><a href="#TTL-索引" class="headerlink" title="TTL 索引"></a>TTL 索引</h3><p>TTL 索引可自动清理不重要的过期数据，例如过期的 session。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.test.createIndex(&#123;</span><br><span class="line">  created: 1</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  expireAfterSeconds: 3600 * 24</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>TTL 索引过期后，将自动删除对应的文档。</p>
<h3 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h3><p>关系型数据库的索引，无法支持 <strong>模糊匹配</strong>（<code>like</code>），MongoDB 索引也一样，无法支持 <strong>正则表达式</strong>。</p>
<p>唯一的例外是前缀固定的正则表达式，这种是可以命中索引的，但前缀固定的应用场景太局限了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;a: &apos;This is a tree.&apos;&#125;</span><br><span class="line"></span><br><span class="line">find(&#123;a: /tree/&#125;)    // 模糊匹配不能命中索引</span><br><span class="line">find(&#123;a: /^tree/&#125;)   // 前缀固定的模糊匹配可以命中索引</span><br></pre></td></tr></table></figure>
<p>第二条虽然命中了索引，但并没有什么卵用，此时可以用全文索引取代正则表达式。</p>
<blockquote>
<p>实际上如果真要用全文索引，还不如直接上 ES。</p>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h4 id="1-命中索引的查询是否一定更快？"><a href="#1-命中索引的查询是否一定更快？" class="headerlink" title="1. 命中索引的查询是否一定更快？"></a>1. 命中索引的查询是否一定更快？</h4><p>一般而言，命中索引查询速度更快。</p>
<p>索引的作用是从一个大数据集中过滤出一个 <strong>小数据集</strong>，而 OLAP 应用（分析型应用）需要处理大量数据（比如需要加载一个月的全部数据），因此 OLAP 场景中命中索引不一定更快，此时可能集合扫描要更快。</p>
<h4 id="2-有多个可用索引，最后会使用哪个？"><a href="#2-有多个可用索引，最后会使用哪个？" class="headerlink" title="2. 有多个可用索引，最后会使用哪个？"></a>2. 有多个可用索引，最后会使用哪个？</h4><p>若某查询语句可能使用多个索引，则首次执行时 MongoDB 将为所有 index 分别生成查询计划，并执行所有计划，第一个查询出 101 条数据的 index 将被选中，以后执行该查询时，将直接使用该索引。</p>
<p>因此首次执行查询时，速度可能会稍微慢一点，而且 MongoDB 重启后需要重新进行评估，当然也可以通过指令强制进行更新。</p>
<h4 id="3-查询慢？"><a href="#3-查询慢？" class="headerlink" title="3. 查询慢？"></a>3. 查询慢？</h4><ul>
<li>是否命中索引？</li>
<li>是否有类似 <code>toArray</code> 的操作，导致将结果集一次性加载到内存中？</li>
</ul>
<h4 id="4-CPU-占用高？"><a href="#4-CPU-占用高？" class="headerlink" title="4. CPU 占用高？"></a>4. CPU 占用高？</h4><p>正常场景中，MongoDB 几乎不怎么消耗 CPU。若未命中索引，CPU 利用明显升高。</p>
<h4 id="5-IO-高（最常见）？"><a href="#5-IO-高（最常见）？" class="headerlink" title="5. IO 高（最常见）？"></a>5. IO 高（最常见）？</h4><ul>
<li>未命中索引<ul>
<li>MongoDB 会把文档从磁盘加载到内存中以进行查询操作，从而造成大量磁盘 IO；</li>
</ul>
</li>
<li>内存不足<ul>
<li>MongoDB 内存将与硬盘进行交换，以便将所需索引从磁盘加载到内存，也会造成大量 IO；</li>
<li><code>nYields</code> 字段</li>
</ul>
</li>
</ul>
<p>其中 3-5 是常见的性能问题，性能问题的原因非常多，这里仅仅从索引角度进行分析，并不全面。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MongoDB/" rel="tag"># MongoDB</a>
          
            <a href="/tags/索引/" rel="tag"># 索引</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/16/2018-09-16-mongodb-objectid-generation/" rel="next" title="MongoDB | ObjectId 生成">
                <i class="fa fa-chevron-left"></i> MongoDB | ObjectId 生成
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/24/2018-09-24-mongodb-explain-hint-intro/" rel="prev" title="MongoDB | explain 与 hint">
                MongoDB | explain 与 hint <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Song Kun</p>
              <p class="site-description motion-element" itemprop="description">Java for living, Scala for fun!</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">148</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">129</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/kun-song" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:songkun.fp@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本术语"><span class="nav-number">1.</span> <span class="nav-text">基本术语</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#index-key-data-page"><span class="nav-number">1.1.</span> <span class="nav-text">index/key/data page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#covered-query-fetch"><span class="nav-number">1.2.</span> <span class="nav-text">covered query/fetch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ixscan-collscan"><span class="nav-number">1.3.</span> <span class="nav-text">ixscan/collscan</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#query-shape"><span class="nav-number">1.4.</span> <span class="nav-text">query shape</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index-prefix"><span class="nav-number">1.5.</span> <span class="nav-text">index prefix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#selectivity"><span class="nav-number">1.6.</span> <span class="nav-text">selectivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复合索引-vs-多个单独索引"><span class="nav-number">1.7.</span> <span class="nav-text">复合索引 vs 多个单独索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引原理"><span class="nav-number">2.</span> <span class="nav-text">索引原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#索引的数据结构"><span class="nav-number">2.1.</span> <span class="nav-text">索引的数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单字段索引"><span class="nav-number">2.1.1.</span> <span class="nav-text">单字段索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复合索引"><span class="nav-number">2.1.2.</span> <span class="nav-text">复合索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引作用：过滤"><span class="nav-number">2.2.</span> <span class="nav-text">索引作用：过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引作用：排序"><span class="nav-number">2.3.</span> <span class="nav-text">索引作用：排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引顺序"><span class="nav-number">2.4.</span> <span class="nav-text">索引顺序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查询"><span class="nav-number">2.4.1.</span> <span class="nav-text">查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排序"><span class="nav-number">2.4.2.</span> <span class="nav-text">排序</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建索引"><span class="nav-number">3.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用原则"><span class="nav-number">4.</span> <span class="nav-text">使用原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特殊索引"><span class="nav-number">5.</span> <span class="nav-text">特殊索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#哈希索引"><span class="nav-number">5.1.</span> <span class="nav-text">哈希索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部分索引"><span class="nav-number">5.2.</span> <span class="nav-text">部分索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TTL-索引"><span class="nav-number">5.3.</span> <span class="nav-text">TTL 索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全文索引"><span class="nav-number">5.4.</span> <span class="nav-text">全文索引</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">6.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-命中索引的查询是否一定更快？"><span class="nav-number">6.0.1.</span> <span class="nav-text">1. 命中索引的查询是否一定更快？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-有多个可用索引，最后会使用哪个？"><span class="nav-number">6.0.2.</span> <span class="nav-text">2. 有多个可用索引，最后会使用哪个？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-查询慢？"><span class="nav-number">6.0.3.</span> <span class="nav-text">3. 查询慢？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-CPU-占用高？"><span class="nav-number">6.0.4.</span> <span class="nav-text">4. CPU 占用高？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-IO-高（最常见）？"><span class="nav-number">6.0.5.</span> <span class="nav-text">5. IO 高（最常见）？</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Song Kun</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
















  
  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.2.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  
  

  
  

  


  
  

  

  

  

  

  

</body>
</html>
